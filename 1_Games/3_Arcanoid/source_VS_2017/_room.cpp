#include "precompiledHeaders.h"
#include "_room.h"


_room::_room(usint mapSizeX, usint mapSizeY) : map(mapSizeX, mapSizeY), isViewedBefore(new bool*[mapSizeY]){
	for (usint i = 0; i < mapSizeY; ++i) {
		isViewedBefore[i] = new bool[mapSizeX];
		for (usint j = 0; j < mapSizeX; ++j) {
			map[i][j].SetBasicSymbol('.');
			isViewedBefore[i][j] = 0;
		}
	}
	mobSize = 0;
	mob = player = nullptr;
}

_room::~_room(){
	for (usint i = 0; i < map.GetSizey(); ++i)
		delete[] isViewedBefore[i];
	delete[] isViewedBefore;
}

void _room::PlaceObjectsOnMap() {
	map[player->GetPos().Y][player->GetPos().X].SetDisplaySymbol(player->GetSymbol());
	map[player->GetPos().Y][player->GetPos().X].SetDisplayColor(player->GetColor());

	for (uint i = 0; i < mobSize; ++i) {
		map[mob[i].GetPos().Y][mob[i].GetPos().X].SetDisplaySymbol(mob[i].GetSymbol());
		map[mob[i].GetPos().Y][mob[i].GetPos().X].SetDisplayColor(mob[i].GetColor());
	}

}

void _room::DoMobTurns(const unsigned long long int ticTimer) {
	for (uint i = 0; i < mobSize; ++i) {
		if (mob[i].reaction.GetCurr() == -1)
			continue;

		if (ticTimer % mob[i].reaction.GetCurr() == 0) {
			 AI_DoTurn(mob[i]);
		}

	}
}

_mobBasic * _room::MobOnPos(COORD pos) {
	if ( (pos.X < 0 || pos.X >= GetSizex()) || (pos.Y < 0 || pos.Y >= GetSizey()) )
		return nullptr;

	for (uint i = 0; i < mobSize; ++i) 
		if (mob[i].GetPos().X == pos.X && mob[i].GetPos().Y == pos.Y)
			return &(mob[i]);

	return nullptr;
}

void _room::SetMap(const dungeonMap &newMap) {
	for (usint i = 0; i < newMap.GetSizey(); ++i)
		for (usint j = 0; j < newMap.GetSizex(); ++j) {
			map[i][j].SetBasicSymbol(newMap[i][j].GetBasicSymbol());
			map[i][j].SetBasicColor(newMap[i][j].GetBasicColor());
			map[i][j].SetIsSolid(newMap[i][j].GetIsSolid());
		}
}

void _room::GenerateRandomMaze() {
	dungeonMap kkk(map.GetSizex(), map.GetSizey());

	const char *arr[] = {
		"........................................................................................................................................................................................................",
		"............-------------------.........................................................................................................................................................................",
		"........            ....................................................................................................................................................................................",
		"......1235613426123613265126............................................................................................................................................................................",
		"...sagsdgkherilsughlnshlrenhjljershl....................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",

	};

	for (usint i = 0; i < kkk.GetSizey(); ++i) {
		for (usint j = 0; j < kkk.GetSizex(); ++j) {
			kkk[i][j].SetBasicSymbol(rand() % 2 == 0?'`':'.');
			kkk[i][j].SetBasicColor({ outputStyle::color::Green , outputStyle::color::Black });
		}
	}

	for (usint i = 0; i < kkk.GetSizey(); ++i) {
		for (usint j = 0; j < 15; ++j) {
			kkk[i][j].SetBasicSymbol('#');
			kkk[i][j].SetBasicColor({ outputStyle::color::DarkGray , outputStyle::color::Black });
			kkk[i][j].SetIsSolid(true);
		}
	}
	for (usint i = 0; i < kkk.GetSizey(); ++i) {
		for (usint j = kkk.GetSizex() - 22; j < kkk.GetSizex(); ++j) {
			kkk[i][j].SetBasicSymbol('#');
			kkk[i][j].SetBasicColor({ outputStyle::color::DarkGray , outputStyle::color::Black });
			kkk[i][j].SetIsSolid(true);
		}
	}
	for (usint i = 0; i < 5; ++i) {
		for (usint j = 0; j < kkk.GetSizex(); ++j) {
			kkk[i][j].SetBasicSymbol('#');
			kkk[i][j].SetBasicColor({ outputStyle::color::DarkGray , outputStyle::color::Black });
			kkk[i][j].SetIsSolid(true);
		}
	}
	for (usint i = kkk.GetSizey() - 10; i < kkk.GetSizey(); ++i) {
		for (usint j = 0; j < kkk.GetSizex(); ++j) {
			kkk[i][j].SetBasicSymbol('#');
			kkk[i][j].SetBasicColor({ outputStyle::color::DarkGray , outputStyle::color::Black });
			kkk[i][j].SetIsSolid(true);
		}
	}

	SetMap(kkk);

	mobSize = 3;
	mob = new _mobBasic[3];

	mob[0].reaction.SetBase(50);
	mob[0].SetSymbol('A');
	mob[0].SetColor({outputStyle::color::Green, outputStyle::color::White});
	mob[0].SetPos({152, 50});
	mob[0].lengthOfView.SetBase(10);

	mob[1].reaction.SetBase(100);
	mob[1].SetSymbol('B');
	mob[1].SetColor({ outputStyle::color::Brown, outputStyle::color::White });
	mob[1].SetPos({ 154, 50 });
	mob[1].lengthOfView.SetBase(3);

	mob[2].reaction.SetBase(200);
	mob[2].SetSymbol('C');
	mob[2].SetColor({ outputStyle::color::LightRed, outputStyle::color::White });
	mob[2].SetPos({ 156, 50 });
	mob[2].lengthOfView.SetBase(1);
}

usint _room::GetSizex() const {
	return map.GetSizex();
}
usint _room::GetSizey() const {
	return map.GetSizey();
}

dungeonMap & _room::GetDisplayInfo() {
	map.SetDisplayBasic();
	PlaceObjectsOnMap();
	return map;
}

dungeonMap & _room::GetMap() {
	return GetDisplayInfo();
}

//----------------- Private -------------------------------
bool _room::AI_SeePlayer(_mobBasic &mob) {
	COORD mobPos = mob.GetPos();
	COORD startPos = { mobPos.X - mob.lengthOfView.GetCurr(), mobPos.Y - mob.lengthOfView.GetCurr() },
		endPos = { mobPos.X + mob.lengthOfView.GetCurr(), mobPos.Y + mob.lengthOfView.GetCurr() };
	if (startPos.X <= player->GetPos().X && player->GetPos().X <= endPos.X)
		if (startPos.Y <= player->GetPos().Y && player->GetPos().Y <= endPos.Y)
			return 1;
	return 0;
}

bool _room::AI_Move(_mobBasic &mob, AI_COMMAND moveDir) {
	if (moveDir == AI_COMMAND::NONE)
		return 0;

	COORD moveDirection[4] = {
		{ mob.GetPos().X - 1 , mob.GetPos().Y },
	{ mob.GetPos().X + 1 , mob.GetPos().Y },
	{ mob.GetPos().X , mob.GetPos().Y + 1 },
	{ mob.GetPos().X , mob.GetPos().Y - 1 }
	};
	int mobTurn = moveDir - 1;

	if (map[moveDirection[mobTurn].Y][moveDirection[mobTurn].X].GetIsSolid() == false) {
		for (uint i = 0; i < mobSize; ++i) {
			if (this->mob[i].GetPos() == moveDirection[mobTurn]) {
				return 0;
			}
			if (this->player->GetPos() == moveDirection[mobTurn]) {
				return 0;
			}
		}
		mob.SetPos({ moveDirection[mobTurn].X, moveDirection[mobTurn].Y });
		return 1;
	}
	else {
		//Wall 
		return 0;
	}

}

bool _room::AI_MoveIfSeeWithoutWall(_mobBasic &mob) {
	bool seePlayer = AI_SeePlayer(mob);
	if (seePlayer) {
		COORD playerPos = player->GetPos(), mobPos = mob.GetPos();
		AI_COMMAND moveDirX = AI_COMMAND::NONE, moveDirY = AI_COMMAND::NONE;

		if (playerPos.X < mobPos.X)
			moveDirX = AI_COMMAND::MOVE_LEFT;
		else if (playerPos.X > mobPos.X)
			moveDirX = AI_COMMAND::MOVE_RIGHT;

		if (playerPos.Y > mobPos.Y)
			moveDirY = AI_COMMAND::MOVE_DOWN;
		else if (playerPos.Y < mobPos.Y)
			moveDirY = AI_COMMAND::MOVE_UP;

		bool rez = 0;
		if(rand() % 2)
			rez = AI_Move(mob, moveDirX);
		else
			rez = AI_Move(mob, moveDirY);
		if (!rez) {
			if (moveDirX == AI_COMMAND::NONE && moveDirY != AI_COMMAND::NONE)
				rez = AI_Move(mob, moveDirY);
			if (moveDirY == AI_COMMAND::NONE && moveDirX != AI_COMMAND::NONE)
				rez = AI_Move(mob, moveDirX);
		}
		return rez;
	}
	return 0;
}

bool _room::AI_DoTurn(_mobBasic &mob) {
	return AI_MoveIfSeeWithoutWall(mob);
}
