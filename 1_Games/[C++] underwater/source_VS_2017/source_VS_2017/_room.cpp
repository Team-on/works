#include "precompiledHeaders.h"
#include "_room.h"


_room::_room(usint mapSizeX, usint mapSizeY) : map(mapSizeX, mapSizeY), isViewedBefore(new bool*[mapSizeY]){
	for (usint i = 0; i < mapSizeY; ++i) {
		isViewedBefore[i] = new bool[mapSizeX];
		for (usint j = 0; j < mapSizeX; ++j) {
			map[i][j].SetBasicSymbol('.');
			isViewedBefore[i][j] = 0;
		}
	}
	mobSize = 0;
	mob = nullptr;
	player = nullptr;
}

_room::~_room(){
	for (usint i = 0; i < map.GetSizey(); ++i)
		delete[] isViewedBefore[i];
	delete[] isViewedBefore;
}

void _room::PlaceObjectsOnMap() {
	map[player->GetPos().Y][player->GetPos().X].SetDisplaySymbol(player->GetSymbol());
	map[player->GetPos().Y][player->GetPos().X].SetDisplayColor(player->GetColor());

	for (uint i = 0; i < mobSize; ++i) {
		map[mob[i].GetPos().Y][mob[i].GetPos().X].SetDisplaySymbol(mob[i].GetSymbol());
		map[mob[i].GetPos().Y][mob[i].GetPos().X].SetDisplayColor(mob[i].GetColor());
	}

}

void _room::DoMobTurns(const unsigned long long int ticTimer) {
	for (uint i = 0; i < mobSize; ++i) {
		if (mob[i].reaction.GetCurr() == -1)
			continue;

		if (ticTimer % mob[i].reaction.GetCurr() == 0)
			mob[i].AI_MoveIfSeeWithoutWall(*this);

	}
}

ullint _room::CalcTicTimerStep() const {
	ullint maxReact = player->reaction.GetCurr();
	for (uint i = 0; i < mobSize; ++i) 
		if (maxReact < mob[i].reaction.GetCurr())
			maxReact = mob[i].reaction.GetCurr();

	ullint step = maxReact;
	while (1) {
		bool isUn = 0;

		if (player->reaction.GetCurr() % step == 0) {
			for (uint i = 0; i < mobSize; ++i) {
				if (mob[i].reaction.GetCurr() != -1) {
					if (mob[i].reaction.GetCurr() % step != 0) {
						isUn = 1;
						break;
					}
				}
			}
		}
		else
			isUn = 1;

		if (!isUn)
			return step;
		--step;
	}
}

ullint _room::CalcTicTimerMax() const {
	ullint maxReact = player->reaction.GetCurr();
	for (uint i = 0; i < mobSize; ++i)
		if (maxReact < mob[i].reaction.GetCurr())
			maxReact = mob[i].reaction.GetCurr();

	ullint max = maxReact;
	while (1) {
		bool isUn = 0;

		if (max % player->reaction.GetCurr() == 0) {
			for (uint i = 0; i < mobSize; ++i) {
				if (mob[i].reaction.GetCurr() != -1) {
					if (max % mob[i].reaction.GetCurr() != 0) {
						isUn = 1;
						break;
					}
				}
			}
		}
		else
			isUn = 1;

		if (!isUn) {
			return max;
		}
		++max;
	}
}

_mobBasic * _room::MobOnPos(COORD pos) {
	if ( (pos.X < 0 || pos.X >= GetSizex()) || (pos.Y < 0 || pos.Y >= GetSizey()) )
		return nullptr;

	for (uint i = 0; i < mobSize; ++i) 
		if (mob[i].GetPos().X == pos.X && mob[i].GetPos().Y == pos.Y)
			return &(mob[i]);

	return nullptr;
}

void _room::SetMap(const dungeonMap &newMap) {
	for (usint i = 0; i < newMap.GetSizey(); ++i)
		for (usint j = 0; j < newMap.GetSizex(); ++j) {
			map[i][j].SetBasicSymbol(newMap[i][j].GetBasicSymbol());
			map[i][j].SetBasicColor(newMap[i][j].GetBasicColor());
			map[i][j].SetIsSolid(newMap[i][j].GetIsSolid());
		}
}

void _room::GenerateRandomMaze() {
	dungeonMap kkk(map.GetSizex(), map.GetSizey());

	const char *arr[] = {
		"........................................................................................................................................................................................................",
		"............-------------------.........................................................................................................................................................................",
		"........            ....................................................................................................................................................................................",
		"......1235613426123613265126............................................................................................................................................................................",
		"...sagsdgkherilsughlnshlrenhjljershl....................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",
		"........................................................................................................................................................................................................",

	};

	for (usint i = 0; i < kkk.GetSizey(); ++i) {
		for (usint j = 0; j < kkk.GetSizex(); ++j) {
			kkk[i][j].SetBasicSymbol(rand() % 2 == 0?'`':'.');
			outputStyle::color color = outputStyle::color( rand() % 9);

			if(i < kkk.GetSizey() / 3 && j <= kkk.GetSizex() / 3)
				kkk[i][j].SetBasicColor({ color , outputStyle::color::Magenta });
			else if (i < kkk.GetSizey() / 3 && j < kkk.GetSizex() / 3 * 2)
				kkk[i][j].SetBasicColor({ color , outputStyle::color::Cyan });
			else if (i < kkk.GetSizey() / 3)
				kkk[i][j].SetBasicColor({ color , outputStyle::color::Blue });

			else if (i <= kkk.GetSizey() / 3 * 2 && j <= kkk.GetSizex() / 3)
				kkk[i][j].SetBasicColor({ color , outputStyle::color::Brown });
			else if (i <= kkk.GetSizey() / 3 * 2 && j < kkk.GetSizex() / 3 * 2)
				kkk[i][j].SetBasicColor({ color , outputStyle::color::Red });
			else if (i <= kkk.GetSizey() / 3 * 2)
				kkk[i][j].SetBasicColor({ color , outputStyle::color::Green });

			else if (j <= kkk.GetSizex() / 3)
				kkk[i][j].SetBasicColor({ color , outputStyle::color::Black });
			else if (j < kkk.GetSizex() / 3 * 2)
				kkk[i][j].SetBasicColor({ color , outputStyle::color::DarkGray });
			else 
				kkk[i][j].SetBasicColor({ color , outputStyle::color::LightGray });
		}
	}

	for (usint i = 0; i < kkk.GetSizey(); ++i) {
		for (usint j = 0; j < 15; ++j) {
			kkk[i][j].SetBasicSymbol('#');
			kkk[i][j].SetBasicColor({ outputStyle::color::DarkGray , outputStyle::color::Black });
			kkk[i][j].SetIsSolid(true);
			kkk[i][j].SetIsLightSolid(true);
		}
	}
	for (usint i = 0; i < kkk.GetSizey(); ++i) {
		for (usint j = kkk.GetSizex() - 22; j < kkk.GetSizex(); ++j) {
			kkk[i][j].SetBasicSymbol('#');
			kkk[i][j].SetBasicColor({ outputStyle::color::DarkGray , outputStyle::color::Black });
			kkk[i][j].SetIsSolid(true);
			kkk[i][j].SetIsLightSolid(true);
		}
	}
	for (usint i = 0; i < 5; ++i) {
		for (usint j = 0; j < kkk.GetSizex(); ++j) {
			kkk[i][j].SetBasicSymbol('#');
			kkk[i][j].SetBasicColor({ outputStyle::color::DarkGray , outputStyle::color::Black });
			kkk[i][j].SetIsSolid(true);
			kkk[i][j].SetIsLightSolid(true);
		}
	}
	for (usint i = kkk.GetSizey() - 10; i < kkk.GetSizey(); ++i) {
		for (usint j = 0; j < kkk.GetSizex(); ++j) {
			kkk[i][j].SetBasicSymbol('#');
			kkk[i][j].SetBasicColor({ outputStyle::color::DarkGray , outputStyle::color::Black });
			kkk[i][j].SetIsSolid(true);
			kkk[i][j].SetIsLightSolid(true);
		}
	}

	SetMap(kkk);

	mobSize = 3;
	mob = new AI_mob[3];

	mob[0].reaction.SetBase(800);
	mob[0].SetSymbol('A');
	mob[0].SetColor({outputStyle::color::Green, outputStyle::color::White});
	mob[0].SetPos({152, 50});
	mob[0].lengthOfView.SetBase(10);

	mob[1].reaction.SetBase(1000);
	mob[1].SetSymbol('B');
	mob[1].SetColor({ outputStyle::color::Brown, outputStyle::color::White });
	mob[1].SetPos({ 154, 50 });
	mob[1].lengthOfView.SetBase(3);

	mob[2].reaction.SetBase(2000);
	mob[2].SetSymbol('C');
	mob[2].SetColor({ outputStyle::color::LightRed, outputStyle::color::White });
	mob[2].SetPos({ 156, 50 });
	mob[2].lengthOfView.SetBase(1);
}

usint _room::GetSizex() const {
	return map.GetSizex();
}
usint _room::GetSizey() const {
	return map.GetSizey();
}

dungeonMap & _room::GetDisplayInfo() {
	map.SetDisplayBasic();
	PlaceObjectsOnMap();
	return map;
}

dungeonMap & _room::GetMap() {
	return GetDisplayInfo();
}

//----------------- Private -------------------------------
